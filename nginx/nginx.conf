# 작업자 프로세스 설정
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # 기본 MIME 타입 설정
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Gzip 압축 설정
    gzip on;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 프록시 설정 (중요)
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=10g inactive=60m use_temp_path=off;

    # --- (1) 업스트림 (FastAPI 서버) ---
    # docker-compose가 'backend'라는 이름으로 서버를 찾아줌
    upstream eternalegacy_api {
        server backend:8000;
    }

    # --- (2) HTTP -> HTTPS 리다이렉션 (Certbot이 수정할 부분) ---
    # (주의!) 여기에 **실제 도메인 이름**을 넣어야 합니다.
    # 예: example.com www.example.com
    server {
        listen 80;
        server_name eternalegacy.org www.eternalegacy.org;

        # Certbot 챌린지 응답을 위한 경로
        location /.well-known/acme-challenge/ {
            root /var/www/html;
        }

        # 나머지 모든 HTTP 요청은 HTTPS로 리다이렉트 (지금은 주석 처리)
        # location / {
        #     return 301 https://$host$request_uri;
        # }
    }

    # --- (3) HTTPS 서버 (SSL 설정) ---
    # (지금은 주석 처리. Certbot 실행 후 주석을 해제합니다)
    #
    # server {
    #     listen 443 ssl http2;
    #     server_name eternalegacy.org www.eternalegacy.org; # <- 실제 도메인
    #
    #     ssl_certificate /etc/letsencrypt/live/eternalegacy.org/fullchain.pem; # <- 실제 도메인
    #     ssl_certificate_key /etc/letsencrypt/live/eternalegacy.org/privkey.pem; # <- 실제 도메인
    #     include /etc/letsencrypt/options-ssl-nginx.conf;
    #     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    #
    #     location / {
    #         # 캐시 설정
    #         proxy_cache api_cache;
    #         proxy_cache_valid 200 302 10m;
    #         proxy_cache_valid 404 1m;
    #         proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    #
    #         # 실제 FastAPI 서버로 요청 전달
    #         proxy_pass http://eternalegacy_api;
    #         proxy_set_header Host $host;
    #         proxy_set_header X-Real-IP $remote_addr;
    #         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #         proxy_set_header X-Forwarded-Proto $scheme;
    #     }
    # }
}
